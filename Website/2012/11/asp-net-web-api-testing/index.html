<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="last-modified" content="2013-08-06T18:02:07.5146518+01:00" />
    <title>philliphaydon.com</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
</head>
<body class="home blog">
    <div id="page" class="hfeed site">
        <header id="masthead" class="site-header fancy-container lightgreen" role="banner">
            <hgroup>
                <h1 class="site-title"><a href="/" title="philliphaydon.com" rel="home">philliphaydon.com</a></h1>
                <h2><small>Works on my PC...</small></h2>
                <p class="site-description">Pleb from New Zealand who was banished overseas and currently resides in Singapore.</p>
            </hgroup>
            <nav role="navigation" class="site-navigation main-navigation">
                <h1 class="assistive-text">Menu</h1>
                <div class="assistive-text skip-link"><a href="#content" title="Skip to content">Skip to content</a></div>
                <div class="menu">
                    <ul>
                        <li><a href="/about">About</a></li>
                        <li><a href="/category">Categories</a></li>
                        <li><a href="/archive">Archive</a></li>
                        <li><a href="/rss">RSS</a> / <a href="/feed">Atom</a></li>
                    </ul>
                </div>
            </nav>
        </header>
        <div id="main">
            <div id="primary" class="site-content">
                <div id="content" role="main">
                  

<div id="post">
    <h1>ASP.NET Web API Testing</h1>

    <div class="post-note">
      posted on 29 Nov 2012
       | <a href="/category/.net">.net</a>
       | <a href="/category/c#">c#</a>
       | <a href="/category/asp.net-web-api">asp.net web api</a>
       | <a href="/category/community">community</a>
       | <a href="/category/github">github</a>
       | <a href="/category/nancyfx">nancyfx</a>
       | <a href="/category/oss">oss</a>
      
      <div class="addthis_toolbox addthis_default_style" style="float:right;">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_linkedin_counter"></a>
        <a class="addthis_counter addthis_pill_style"></a>
      </div>
    </div>
        
    <h2>ASP.NET Web API Testing</h2>

<p>As the need arose to implement some kind of Web Service/HTTP API I thought I would evaluate <a href="http://nancyfx.org/">NancyFX</a>, <a href="http://www.asp.net/web-api">ASP.NET Web API</a> and <a href="http://www.servicestack.net/">ServiceStack</a>.</p>

<p>Suffice to say all performed as expected and I was actually surprised to find that implementing ASP.NET Web API was easier than ServiceStack (I know that might be a bit of a statement to make to the ServiceStack followers, sorry). I found Nancy easiest to implement. The very simple API demos can be found on <a href="http://github.com/jchannon">my Github page</a>.</p>

<p>When it came to testing ASP.NET Web API I found it to be wanting slightly in comparison to Nancy. With WebAPI I could make direct calls to the controller methods to make sure data was returned correctly and I could mock a repository and test that the methods in the repository were being called but there was nothing I could see to test the HTTP response I would get.</p>

<!--excerpt-->

<p>I found that you could configure a lot of stuff to get a HttpResponseMessage back as shown below however in my opinion it wasn’t particularly easy on the eye and seemed a bit over the top just to get a response back.</p>

<pre><code>//Arrange
var config = new HttpConfiguration();
var request = new HttpRequestMessage(HttpMethod.Post, "http://localhost/api/products");
var route = config.Routes.MapHttpRoute("DefaultApi", "api/{controller}/{id}");
var routeData = new HttpRouteData(route, new HttpRouteValueDictionary { { "controller", "products" } });
var controller = new ProductsController(repo);
controller.ControllerContext = new HttpControllerContext(config, routeData, request);
controller.Request = request;
controller.Request.Properties[HttpPropertyKeys.HttpConfigurationKey] = config;
</code></pre>

<p>Then you can call your controller method and assert against it.</p>

<pre><code>// Act
var result = controller.PostProduct(new Product { Id = 1 });

// Assert
Assert.Equal(HttpStatusCode.Created, result.StatusCode);
</code></pre>

<p>I can’t take credit for finding this out though. I found it on <a href="http://www.peterprovost.org/blog/2012/06/16/unit-testing-asp-dot-net-web-api/">Peter Provost</a> blog post where he says <a href="http://bradwilson.typepad.com/">Brad Wilson</a> helped him construct the code.</p>

<p>I wasn’t positive whether the HTTP response returned was as pure as if the request was actually made to a server. By understanding the <a href="https://github.com/NancyFx/Nancy/tree/master/src/Nancy.Testing">Nancy.Testing</a> library I knew that the response given there was an exact copy of what would be given if hitting a server.</p>

<p>I then investigated a bit more and found a great blog post by <a href="http://www.strathweb.com/2012/06/asp-net-web-api-integration-testing-with-in-memory-hosting/">Filip W</a> about in-memory hosting. This essentially mirrors a server in terms of receiving a request and issuing a response.</p>

<p>Knowing what I knew from Nancy I thought I could apply it to Web API. What this meant was you could submit requests and test against the response. I’m not sure how you would classify it in terms of unit testing or integration testing because the tests run very quickly but I suppose you are hitting an actual server albeit in memory.</p>

<p>Here’s what a simple test looks like:</p>

<pre><code>public class GetDataTests
{
    [Fact]
    public void GetData_WhenRequested_ShouldReturnJSON()
    {
        var browser = new Browser();
        var response = browser.Get("/GetData", (with) =&gt;
        {
            with.Header("Accept", "application/json");
            with.HttpRequest();
        });

        Assert.Equal("application/json", response.Content.Headers.ContentType.MediaType);
    }

    [Fact]
    public void GetData_WhenRequested_ShouldReturnOKStatusCode()
    {
        var browser = new Browser();
        var response = browser.Get("/GetData", (with) =&gt;
        {
            with.Header("Authorization", "Bearer johnsmith");
            with.Header("Accept", "application/json");
            with.HttpRequest();
        });

        Assert.Equal(HttpStatusCode.Forbidden, response.StatusCode);
    }
}
</code></pre>

<p>You define your test, in this case <a href="http://xunit.codeplex.com/">xUnit</a>. You create an instance of the Browser class. This is just a class name there is no browser, it doesn’t fire up IE or anything like that. You then call a method named after a HTTP verb with a path specified. You also have the ability to specify items within the request such as headers, form values and cookies using a delegate. The methods in the Browser class will return a HttpResponseMessage which is what Web API server returns and you can then assert against the response.</p>

<p>Delving a little deeper into the code, the Browser class takes an optional HttpConfiguration constructor argument or if one is not supplied it uses the below configuration. It then creates an instance of HttpServer and passes the configuration into it.</p>

<pre><code>private readonly HttpServer _server;

public Browser()
{
    var config = new HttpConfiguration();
    config.Routes.MapHttpRoute(name: "Default", routeTemplate: "api/{controller}/{action}/{id}", defaults: new { id = RouteParameter.Optional });
    config.IncludeErrorDetailPolicy = IncludeErrorDetailPolicy.Always;
    _server = new HttpServer(config);
}
</code></pre>

<p>When a method is called it then builds up a HttpRequestMessage using the items defined in the delegate in the unit test and passes it to the server variable and the HttpResponseMessage is returned.</p>

<pre><code>public HttpResponseMessage Get(string path, Action browserContext = null)
{
  return this.HandleRequest(HttpMethod.Get, path, browserContext);
}

private HttpResponseMessage HandleRequest(HttpMethod method, string path, Action browserContext)
{
    var request = CreateRequest(method, path, browserContext ?? this.DefaultBrowserContext);

    if (BrowserHttpClient == null)
        BrowserHttpClient = new HttpClient(_server);

    HttpResponseMessage response = BrowserHttpClient.SendAsync(request).Result;

    request.Dispose();

    if (_server != null)
    {
        _server.Dispose();
    }

    return response;
}
</code></pre>

<p>This gives you the ability to pretty much test the full pipeline of a request and response.</p>

<p>The Github repository is located <a href="https://github.com/jchannon/WebAPI.Testing">here</a> and if you like what you see please take a closer look into <a href="http://nancyfx.org/">NancyFX</a>.</p>

<p><img src="http://blog.jonathanchannon.com/wp-content/uploads/2012/11/nancy-horizontal-framed-bf-wb-620x240.png" alt="NancyFX" title="NancyFX" /></p>

<p><em>NancyFX</em></p>

<p><strong>UPDATE 7th Dec 2012:</strong> The project is available on <a href="http://nuget.org/packages/WebAPI.Testing">Nuget</a></p>


	<div class="divider"></div>
	<div id="disqus_thread"></div>
	<script>
	    var disqus_shortname = 'philliphaydon';
	    var disqus_url = "http://www.philliphaydon.com@Model.Url";

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function () {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    
	<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51ca97356d8c1454"></script>

</div>
                </div>
                <!-- #content -->
            </div>
            <!-- #primary .site-content -->

            <div id="secondary" class="widget-area fancy-container lightred" role="complementary">
                <aside id="text-5" class="widget widget_text">
                    <h1 class="widget-title">Follow</h1>
                    <div class="textwidget logos">
                        <a href="https://twitter.com/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                        <a href="http://stackoverflow.com/users/456813/phill" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://stackoverflow.com']);"><img src="/stylesheets/images/stackoverflow.png"></a>
                        <a href="http://www.linkedin.com/in/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                        <a href="https://plus.google.com/u/0/111751877537461442095" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://plus.google.com']);"><img src="/stylesheets/images/googleplus.png"></a>
                        <a href="https://coderbits.com/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','https://coderbits.com/philliphaydon']);"><img src="/stylesheets/images/codebits.png"></a>
                        <a href="https://github.com/phillip-haydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>
                        <a href="http://www.codeschool.com/users/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://codeschool.com']);"><img src="/stylesheets/images/codeschool.png"></a>
                        <a href="http://www.kickstarter.com/profile/phillip-haydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://kickstarter.com']);"><img src="/stylesheets/images/kickstarter.png"></a>
                    </div>
                    <a href="http://stackoverflow.com/users/456813/phill">
                      <img src="http://stackoverflow.com/users/flair/456813.png" width="208" height="58" alt="profile for Phill at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for Phill at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
                    </a>
                    
                    <a href="http://nancyfx.org/mvm.html"><img src="/stylesheets/images/mvm.png"></a>
                    
                    <div id = "clustrback" style="width:162px; height:133px;  background:#f7f7f7 url(http://clustrmaps.com/admin/3d/images/st4_grey.png)  center no-repeat; text-align:center;">
                      <a href="http://www2.clustrmaps.com/counter/maps.php?url=http://www.philliphaydon.com/" style="width:160px; display:block; margin:0 auto;" id="clustrMapsLink">
                        <img src="http://www2.clustrmaps.com/counter/index2.php?url=http://www.philliphaydon.com/" style="border:0px; margin:15px auto;margin:15px auto;" alt="Locations of visitors to this page" title="Locations of visitors to this page" id="clustrMapsImg" />
                      </a>
                    </div>
                </aside>
                <!--aside id="text-8" class="widget widget_text">
                    <h1 class="widget-title">Other sites</h1>
                    <div class="textwidget">
                        <a href="http://csharptube.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://csharptube.com']);">csharptube.com</a><br />
                        <a href="http://thisisparrot.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://thisisparrot.com']);">Parrot</a><br />
                        <a href="http://shitprogrammerswrite.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://shitprogrammerswrite.com']);">Shit programmers write</a><br />
                    </div>
                </aside-->
                <aside id="linkcat-6" class="widget widget_links">
                    <h1 class="widget-title">Other Blogs</h1>
                    <ul class='xoxo blogroll'>
                        <li><a href="http://www.nickharris.net/" target="_top" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://nickharris.net/']);">Nick Harris</a></li>
                        <li><a href="http://www.mindscapehq.com/blog/" target="_top" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://www.mindscapehq.com/blog/']);">Mindscape</a></li>
                        <li><a href="http://blog.orangelightning.co.uk/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://blog.orangelightning.co.uk/']);">Phil Jones</a></li>
                        <li><a href="http://buildstarted.com/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://buildstarted.com']);">Ben Dornis</a></li>
                        <li><a href="http://jflood.net/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://jflood.net/']);">Jospeh Flood</a></li>
                    </ul>
                    
                </aside>
                <aside id="archives-4" class="widget widget_archive">
                    <h1 class="widget-title">Archive</h1>
                    <ul class="posts">
                          <li><a href="/archive#2013July">July, 2013</a></li>
                          <li><a href="/archive#2013May">May, 2013</a></li>
                          <li><a href="/archive#2013April">April, 2013</a></li>
                          <li><a href="/archive#2013March">March, 2013</a></li>
                          <li><a href="/archive#2013February">February, 2013</a></li>
                          <li><a href="/archive#2013January">January, 2013</a></li>
                          <li><a href="/archive#2012December">December, 2012</a></li>
                          <li><a href="/archive#2012November">November, 2012</a></li>
                          <li><a href="/archive#2012October">October, 2012</a></li>
                          <li><a href="/archive#2012September">September, 2012</a></li>
                    </ul>
                </aside>
            </div>
            <!-- #secondary .widget-area -->


        </div>
        <!-- #main -->

        <footer id="colophon" class="site-footer" role="contentinfo">
            <div class="site-info">
                Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a>.	
            </div>
            <!-- .site-info -->
        </footer>
        <!-- #colophon .site-footer -->
    </div>
    <!-- #page .hfeed .site -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src='/javascripts/prettify.js' type='text/javascript'></script>
    <!--script src='http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js' type='text/javascript'></script-->
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
      });

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-655975-13']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
</body>
</html>
