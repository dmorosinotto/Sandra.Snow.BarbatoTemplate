<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="last-modified" content="2013-08-06T18:02:07.5146518+01:00" />
    <title>philliphaydon.com</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
</head>
<body class="home blog">
    <div id="page" class="hfeed site">
        <header id="masthead" class="site-header fancy-container lightgreen" role="banner">
            <hgroup>
                <h1 class="site-title"><a href="/" title="philliphaydon.com" rel="home">philliphaydon.com</a></h1>
                <h2><small>Works on my PC...</small></h2>
                <p class="site-description">Pleb from New Zealand who was banished overseas and currently resides in Singapore.</p>
            </hgroup>
            <nav role="navigation" class="site-navigation main-navigation">
                <h1 class="assistive-text">Menu</h1>
                <div class="assistive-text skip-link"><a href="#content" title="Skip to content">Skip to content</a></div>
                <div class="menu">
                    <ul>
                        <li><a href="/about">About</a></li>
                        <li><a href="/category">Categories</a></li>
                        <li><a href="/archive">Archive</a></li>
                        <li><a href="/rss">RSS</a> / <a href="/feed">Atom</a></li>
                    </ul>
                </div>
            </nav>
        </header>
        <div id="main">
            <div id="primary" class="site-content">
                <div id="content" role="main">
                  

<div id="post">
    <h1>Simple .Net Twitter,Google,Facebook Authentication</h1>

    <div class="post-note">
      posted on 25 Oct 2012
       | <a href="/category/authentication">authentication</a>
       | <a href="/category/community">community</a>
       | <a href="/category/dinnerparty">dinnerparty</a>
       | <a href="/category/nancyfx">nancyfx</a>
       | <a href="/category/oss">oss</a>
       | <a href="/category/social">social</a>
       | <a href="/category/social-authentication">social authentication</a>
      
      <div class="addthis_toolbox addthis_default_style" style="float:right;">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_linkedin_counter"></a>
        <a class="addthis_counter addthis_pill_style"></a>
      </div>
    </div>
        
    <h2>Simple .Net Twitter,Google,Facebook Authentication</h2>

<p>Logging into websites is no longer a matter of typing in your username and password and clicking the login button. If you already have an account with the main social networks you can log into a site using your credentials from that website saving you having to register your details <em>again</em>. This obviously makes things a bit easier as you don’t have to remember another password. (Although you should all be using a password manager such as <a href="http://www.lastpass.com">LastPass</a>.)</p>

<h2>Current Social Login Providers</h2>

<p>There are currently providers out there that allow you to use their services to integrate into your website to provide authentication via the social networks. The main two that I know of are <a href="http://janrain.com">Janrain</a> and <a href="http://www.dotnetopenauth.net/">DotNetOpenAuth</a>. I’ve not worked with DotNetOpenAuth but I have with Janrain when building <a href="http://blog.jonathanchannon.com/2012/09/21/nancyfx-ravendb-nerddinner-and-me/">DinnerParty</a>.</p>

<p>The process was reasonably easy but not as simple as it could be.</p>

<!--excerpt-->

<h3>.Net Simple Social Authentication</h3>

<p>I was made aware of an OSS project by <a href="http://twitter.com/philliphaydon">@philliphaydon</a> whilst keeping up to speed with the latest <a href="http://nancyfx.org/">NancyFX </a>goings on in <a href="http://jabbr.net">Jabbr</a> that aims to provide a simple way of using social networks to log into a site.</p>

<p>It started out aimed at ASP.Net MVC but after a bit of arm bending from <a href="http://twitter.com/philliphaydon">@philliphaydon</a> it was refactored to be web framework agnostic so it could be used with <a href="http://nancyfx.org/">NancyFX </a>.</p>

<p>Being enthusiastic, I asked if any help was needed and I ended up making a simple demo website using <a href="http://nancyfx.org/">NancyFX</a></p>

<h2>Code Examples</h2>

<p>Let me see some code I hear you say so here we go:</p>

<p><strong>Bootstrapper:</strong></p>

<pre><code>public class Bootstrapper : DefaultNancyBootstrapper
{
    private const string TwitterConsumerKey = "Rb7qNNPUPsRSYkznFTbF6Q";
    private const string TwitterConsumerSecret = "pP1jBdYOlmCzo08QFJjGIHY4YSyPdGLPO2m1q47hu9c";
    private const string FacebookAppId = "159181340893340";
    private const string FacebookAppSecret = "97c4e4d0fa548232cf8f9c68a7adcff9";
    private const string GoogleConsumerKey = "587140099194.apps.googleusercontent.com";
    private const string GoogleConsumerSecret = "npk1_gx-gqJmLiJRPFooxCEY";

   protected override void ApplicationStartup(TinyIoCContainer container, IPipelines pipelines)
   {
       RegisterAuthenticationProviders(container);

       base.ApplicationStartup(container, pipelines);

       CookieBasedSessions.Enable(pipelines);
   }

   private static void RegisterAuthenticationProviders(TinyIoCContainer container)
   {
       Condition.Requires(container).IsNotNull();

       var twitterProvider = new TwitterProvider(TwitterConsumerKey, TwitterConsumerSecret,
                                                 new Uri(
                                                     "http://localhost:6969/AuthenticateCallback?providerKey=Twitter"));

       var facebookProvider = new FacebookProvider(FacebookAppId, FacebookAppSecret,
                                                   new Uri(
                                                       "http://localhost:6969/AuthenticateCallback?providerKey=facebook"));

       var googleProvider = new GoogleProvider(GoogleConsumerKey, GoogleConsumerSecret,
                                               new Uri(
                                                   "http://localhost:6969/AuthenticateCallback?providerKey=google"));

       var authenticationService = new AuthenticationService();
       authenticationService.AddProvider(twitterProvider);
       authenticationService.AddProvider(facebookProvider);
       authenticationService.AddProvider(googleProvider);

       container.Register(authenticationService);
   }
}
</code></pre>

<p><strong>HomeModule</strong></p>

<pre><code>public class HomeModule : NancyModule
{  
   private const string SessionGuidKey = "GUIDKey";

   public HomeModule(IAuthenticationService authenticationService)
   {
       Get["/"] = parameters =&gt; View["login"];

       Get["/RedirectToAuthenticate/{providerKey}"] = parameters =&gt;
              {
                  Session[SessionGuidKey] = Guid.NewGuid();
                  Uri uri =
                      authenticationService.
                          RedirectToAuthenticationProvider(
                              parameters.providerKey,
                              Session[SessionGuidKey].ToString());

                  return Response.AsRedirect(uri.AbsoluteUri);
              };

       Get["/AuthenticateCallback"] = parameters =&gt;
              {
                  if (string.IsNullOrEmpty(Request.Query.providerKey))
                  {
                      throw new ArgumentNullException("providerKey");
                  }

                  // It's possible that a person might hit this resource directly, before any session value
                  // has been set. As such, we should just fake some state up, which will not match the
                  // CSRF check.
                  var existingState = (string)(Session[SessionGuidKey] ?? Guid.NewGuid().ToString());

                  var model = new AuthenticateCallbackViewModel();

                  var querystringParameters = new NameValueCollection();
                  foreach (var item in Request.Query)
                  {
                      querystringParameters.Add(item, Request.Query[item]);
                  }

                  try
                  {
                      model.AuthenticatedClient =
                          authenticationService.CheckCallback(Request.Query.providerKey,
                                                              querystringParameters,
                                                              existingState);
                  }
                  catch (Exception exception)
                  {
                      model.Exception = exception;
                  }

                  return View["AuthenticateCallback", model];
              };
   }
}
</code></pre>

<p>This should hopefully be pretty self explanatory as that is the aim of the game but I will go through it.</p>

<p>Firstly we need to setup our social network key and secret which was provided to us by registering an app at the relevant site. We then setup a IAuthenticationProvider class for Twitter, Google &amp; Facebook with the key, secret and callback URL that the social network will make request to after login. We then register our providers with a IAuthenticationService class.</p>

<p>We then setup our IOC container to use authenticationService so that when our modules like Home take a dependency of IAuthenticationService it will use that.</p>

<p>Our root route provides a login page with hyperlinks to the RedirectToAuthenticate route. For example, using Twitter it will be <strong><em>http://mydomain.com/RedirectToAuthenticate/Twitter</em></strong>.</p>

<p>We create an item in our session so that it can be retrieved later when <a href="http://twitter.com">Twitter</a> calls the callback URL. This is so we can validate(if needs be) that its a valid request and not some cheeky hacker. We then use the IAuthenticationService to redirect to the social network login page based on the value of providerKey argument. This could also be Facebook or Google.</p>

<p>The user is redirected to <a href="http://twitter.com">Twitter</a> and logs in and then gets directed back to our website.</p>

<p>Our AuthenticateCallback route then creates a NameValueCollection from the querystring parameters and passes the providerKey (Twitter,Facebook,Google), NameValueCollection and Session value to the IAuthenticationService to validate all is ok.</p>

<p>If so it creates a view model and passes it to the view and in this example shows us the logged in user’s details.</p>

<p>I think that was pretty simple.</p>

<h2>I want to play</h2>

<p>The source code is over at <a href="https://github.com/PureKrome/World-Domination.Web.Authentication">Github</a> and is written by Pure.Krome or <a href="https://twitter.com/lara_eagle">Lara Eagle</a> if you prefer (same person). It’s also available on <a href="http://nuget.org/packages/World-Domination.Web.Authentication">Nuget</a>. Its name you ask? World-Domination.Web.Authentication</p>


	<div class="divider"></div>
	<div id="disqus_thread"></div>
	<script>
	    var disqus_shortname = 'philliphaydon';
	    var disqus_url = "http://www.philliphaydon.com@Model.Url";

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function () {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    
	<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51ca97356d8c1454"></script>

</div>
                </div>
                <!-- #content -->
            </div>
            <!-- #primary .site-content -->

            <div id="secondary" class="widget-area fancy-container lightred" role="complementary">
                <aside id="text-5" class="widget widget_text">
                    <h1 class="widget-title">Follow</h1>
                    <div class="textwidget logos">
                        <a href="https://twitter.com/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                        <a href="http://stackoverflow.com/users/456813/phill" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://stackoverflow.com']);"><img src="/stylesheets/images/stackoverflow.png"></a>
                        <a href="http://www.linkedin.com/in/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                        <a href="https://plus.google.com/u/0/111751877537461442095" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://plus.google.com']);"><img src="/stylesheets/images/googleplus.png"></a>
                        <a href="https://coderbits.com/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','https://coderbits.com/philliphaydon']);"><img src="/stylesheets/images/codebits.png"></a>
                        <a href="https://github.com/phillip-haydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>
                        <a href="http://www.codeschool.com/users/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://codeschool.com']);"><img src="/stylesheets/images/codeschool.png"></a>
                        <a href="http://www.kickstarter.com/profile/phillip-haydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://kickstarter.com']);"><img src="/stylesheets/images/kickstarter.png"></a>
                    </div>
                    <a href="http://stackoverflow.com/users/456813/phill">
                      <img src="http://stackoverflow.com/users/flair/456813.png" width="208" height="58" alt="profile for Phill at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for Phill at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
                    </a>
                    
                    <a href="http://nancyfx.org/mvm.html"><img src="/stylesheets/images/mvm.png"></a>
                    
                    <div id = "clustrback" style="width:162px; height:133px;  background:#f7f7f7 url(http://clustrmaps.com/admin/3d/images/st4_grey.png)  center no-repeat; text-align:center;">
                      <a href="http://www2.clustrmaps.com/counter/maps.php?url=http://www.philliphaydon.com/" style="width:160px; display:block; margin:0 auto;" id="clustrMapsLink">
                        <img src="http://www2.clustrmaps.com/counter/index2.php?url=http://www.philliphaydon.com/" style="border:0px; margin:15px auto;margin:15px auto;" alt="Locations of visitors to this page" title="Locations of visitors to this page" id="clustrMapsImg" />
                      </a>
                    </div>
                </aside>
                <!--aside id="text-8" class="widget widget_text">
                    <h1 class="widget-title">Other sites</h1>
                    <div class="textwidget">
                        <a href="http://csharptube.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://csharptube.com']);">csharptube.com</a><br />
                        <a href="http://thisisparrot.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://thisisparrot.com']);">Parrot</a><br />
                        <a href="http://shitprogrammerswrite.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://shitprogrammerswrite.com']);">Shit programmers write</a><br />
                    </div>
                </aside-->
                <aside id="linkcat-6" class="widget widget_links">
                    <h1 class="widget-title">Other Blogs</h1>
                    <ul class='xoxo blogroll'>
                        <li><a href="http://www.nickharris.net/" target="_top" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://nickharris.net/']);">Nick Harris</a></li>
                        <li><a href="http://www.mindscapehq.com/blog/" target="_top" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://www.mindscapehq.com/blog/']);">Mindscape</a></li>
                        <li><a href="http://blog.orangelightning.co.uk/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://blog.orangelightning.co.uk/']);">Phil Jones</a></li>
                        <li><a href="http://buildstarted.com/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://buildstarted.com']);">Ben Dornis</a></li>
                        <li><a href="http://jflood.net/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://jflood.net/']);">Jospeh Flood</a></li>
                    </ul>
                    
                </aside>
                <aside id="archives-4" class="widget widget_archive">
                    <h1 class="widget-title">Archive</h1>
                    <ul class="posts">
                          <li><a href="/archive#2013July">July, 2013</a></li>
                          <li><a href="/archive#2013May">May, 2013</a></li>
                          <li><a href="/archive#2013April">April, 2013</a></li>
                          <li><a href="/archive#2013March">March, 2013</a></li>
                          <li><a href="/archive#2013February">February, 2013</a></li>
                          <li><a href="/archive#2013January">January, 2013</a></li>
                          <li><a href="/archive#2012December">December, 2012</a></li>
                          <li><a href="/archive#2012November">November, 2012</a></li>
                          <li><a href="/archive#2012October">October, 2012</a></li>
                          <li><a href="/archive#2012September">September, 2012</a></li>
                    </ul>
                </aside>
            </div>
            <!-- #secondary .widget-area -->


        </div>
        <!-- #main -->

        <footer id="colophon" class="site-footer" role="contentinfo">
            <div class="site-info">
                Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a>.	
            </div>
            <!-- .site-info -->
        </footer>
        <!-- #colophon .site-footer -->
    </div>
    <!-- #page .hfeed .site -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src='/javascripts/prettify.js' type='text/javascript'></script>
    <!--script src='http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js' type='text/javascript'></script-->
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
      });

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-655975-13']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
</body>
</html>
